#!/bin/bash
# Update package list and install required tools

for attempt in {1..3}; do
    sudo apt update && sudo apt install -y apache2 git && break
    echo "Attempt $attempt to install packages failed. Retrying..."
    sleep 5
done

# Repository configuration
REPO_DIR="/var/www/html/frontend"
GIT_URL="https://github.com/Mohamed3873/Cloud-portifolio.git"

# Debug: Print the repository directory path
echo "Checking if directory exists: $REPO_DIR"

# Clone the repository or pull the latest changes
if [ ! -d "$REPO_DIR" ]; then
    echo "Cloning repository..."
    sudo git clone "$GIT_URL" "$REPO_DIR"
else
    echo "Directory exists. Checking if we can pull latest changes..."
    cd "$REPO_DIR"
    sudo git status  # Check if it's a git repo and its status
    sudo git fetch --all  # Fetch latest updates
    sudo git reset --hard origin/main  # Reset to main branch to ensure it's up-to-date
fi

# Copy the index.html file to the Apache document root
sudo cp "$REPO_DIR/src/main/frontend/index.html" /var/www/html/

# Set permissions for Apache to serve files
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

# Ensure Apache is running
sudo systemctl restart apache2
sudo systemctl enable apache2
