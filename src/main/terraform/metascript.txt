#!/bin/bash

# Update package list and install required tools
for attempt in {1..3}; do
    sudo apt update && sudo apt install -y apache2 git && break
    echo "Attempt $attempt to install packages failed. Retrying..."
    sleep 5
done

# Repository configuration
REPO_DIR="/var/www/html/frontend"
GIT_URL="https://github.com/Mohamed3873/Cloud-portifolio.git"
BRANCH="main"

# Ensure the repository exists and always pull the latest changes
if [ ! -d "$REPO_DIR/.git" ]; then
    echo "Cloning repository..."
    sudo rm -rf "$REPO_DIR"  # Clear any non-git directory
    sudo git clone --branch $BRANCH "$GIT_URL" "$REPO_DIR"
    cd "$REPO_DIR"
        sudo git fetch origin
        sudo git reset --hard origin/$BRANCH
else
    echo "Pulling latest changes..."
    cd "$REPO_DIR"
    sudo git fetch origin
    sudo git reset --hard origin/$BRANCH
fi

# Copy the index.html file to the Apache document root
sudo cp "$REPO_DIR/src/main/frontend/index.html" /var/www/html/
echo "index.html copied to Apache document root."

# Set permissions for Apache to serve files
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

sudo systemctl restart apache2
if systemctl is-active --quiet apache2; then
    echo "Apache restarted successfully."
else
    echo "Failed to restart Apache. Check the service status."
    sudo systemctl status apache2
fi
sudo systemctl enable apache2