#!/bin/bash
# Update package list and install required tools

for attempt in {1..3}; do
    sudo apt update && sudo apt install -y python3 python3-pip python3-venv git curl mariadb-client && break
    echo "Attempt $attempt to install packages failed. Retrying..."
    sleep 5
done

# Clone the repository or pull the latest changes
REPO_DIR="/src/main/backend"
GIT_URL="https://github.com/Mohamed3873/Cloud-portifolio.git"

# Clone the repository or pull the latest changes
if [ ! -d "$REPO_DIR" ]; then
    echo "Cloning repository..."
    sudo git clone "$GIT_URL" "$REPO_DIR"
else
    echo "Pulling latest changes..."
    cd "$REPO_DIR" && sudo git pull
fi

# Install the Cloud SQL Auth Proxy
curl -o cloud_sql_proxy https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64
chmod +x cloud_sql_proxy
sudo mv cloud_sql_proxy /usr/local/bin/

# Start the Cloud SQL Auth Proxy to connect to your database instance
cloud_sql_proxy -instances=awesome-destiny-436710-j1:europe-west1:cloud-sql=tcp:3306 &

# Install backend dependencies using pip (manual installation)
cd "$REPO_DIR"
sudo pip3 install python-dotenv flask mariadb

# Set permissions and ensure the backend app is ready
sudo chown -R ubuntu:ubuntu /home/ubuntu/backend
sudo chmod -R 755 /home/ubuntu/backend

# Start the Flask application
cd /src/main/backend
sudo python3 app.py &

# Ensure the Flask app is running
sudo systemctl enable app.service
